pkgname=axum-processes
pkgver=git
pkgrel=16
pkgdesc="Axum Linux Processes"
url="http://192.168.0.9/"
arch=(i686)
depends=('libmbn' 'postgresql-libs')
backup=(etc/conf.d/axum.conf)
license=('GPL')

source=(axum-gateway axum-address axum.conf axum-database.sql)
gitroot="git@192.168.0.9:"

build() {
  # Arch scripts & config
  install -m 755 -d "$pkgdir/etc/rc.d"
  install -m 755 -d "$pkgdir/var/lib/axum"
  install -m 666 "$startdir/axum-database.sql" "$pkgdir/var/lib/axum"
  install -m 755 "$startdir/axum-address" "$pkgdir/etc/rc.d/axum-address"
  install -m 755 "$startdir/axum-gateway" "$pkgdir/etc/rc.d/axum-gateway"
  install -m 755 -d "$pkgdir/etc/conf.d"
  install -m 644 "$startdir/axum.conf" "$pkgdir/etc/conf.d/axum.conf"
  install -m 755 -d "$pkgdir/usr/bin"


  # address server
  cd "$srcdir"
  if [ -d addr/.git ]; then
    (cd addr && git pull "${gitroot}axum-address.git" master && git reset --hard)
  else
    git clone "${gitroot}axum-address.git" addr
  fi

  cd addr
  make || return 1

  install -m 755 axum-address "$pkgdir/usr/bin/axum-address"


  # gateway
  cd $srcdir
  if [ -d gw/.git ]; then
    (cd gw && git pull "${gitroot}axum-gateway.git" master && git reset --hard)
  else
    git clone "${gitroot}axum-gateway.git" gw
  fi

  cd gw
  make || return 1
  install -m 755 axum-gateway "$pkgdir/usr/bin/axum-gateway"


  # engine
  cd $srcdir
  if [ -d en/.git ]; then
    (cd en && git pull "${gitroot}axum-engine.git" master && git reset --hard)
  else
    git clone "${gitroot}axum-engine.git" en
  fi

  cd en
  mkdir dsp
  scp ${gitroot}additional-files/dsp/* dsp/
  make || return 1
  install -m 755 axum-engine "$pkgdir/usr/bin/axum-engine"
  install -m 755 -d "$pkgdir/var/lib/axum/dsp"
  install -m 644 -t "$pkgdir/var/lib/axum/dsp" dsp/*
}

